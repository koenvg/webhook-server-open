#!/usr/bin/env node
require('dotenv').config()

var async = require( 'async' )
var grunt = require( 'grunt' )
var webhookTasks = require( '../Gruntfile.js' )
var fastly = require( '../libs/fastly' )

webhookTasks( grunt )
var cdn = fastly( grunt.config().fastly )

var snippets = process.argv.slice( 2 ).split( ' ' )

var tasks = [ getDevelopmentVersion ]
  .concat( snippets.map( deleteSnippets ) )
  .concat( [ activateVersion ] )


async.waterfall( tasks, function ( error, result ) {
  if ( error ) return console.log( error )
  console.log( `Done. Version: ${ cdn.version() }` )
} )

function getDevelopmentVersion ( taskComplete ) {
  cdn._ensureDevelopmentVersion( taskComplete )
}

function deleteSnippets ( snippetName ) {
  return function deleteSnippet ( options, taskComplete ) {
    var url = `/service/${ cdn._service_id }/version/${ cdn.version() }/snippet/${ snippetName }`
    cdn.request( 'DELETE', url, function ( error, result ) {
      if ( error ) return taskComplete( error )
      taskComplete( null, options )
    } )
  }
}

function activateVersion ( taskComplete ) {
  cdn.activate( taskComplete )
}
